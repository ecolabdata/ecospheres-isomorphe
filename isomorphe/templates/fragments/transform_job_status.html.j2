{% set job_status = job.get_status(refresh=True) %}
{% set results = job.result %}
{% if job_status in ["queued", "started"] %}
  <div hx-get="{{ url_for('transform_job_status', job_id=job.id) }}"
       hx-trigger="load delay:1s"
       hx-swap="outerHTML">{{ now }} — le job est en cours de traitement ({{ job_status }}).</div>
{% elif job_status == "finished" %}
  {# TODO: add normalized info about current connected catalog #}
  <p>Job terminé.</p>
  <p>
    Vous pouvez désormais :
    <ol>
      <li>Contrôler le résultat du traitement.</li>
      <li>Mettre à jour le catalogue en sélectionnant le mode de mise à jour souhaité.</li>
    </ol>

    Seuls les enregistrements modifiés et sélectionnés dans la table ci-dessous seront mis à jour sur le catalogue ({{ url }}).
  </p>

  <form method="post" action="{{ url_for('migrate', job_id=job.id) }}"
        class="fr-mt-2w" id="main-form">

    <div class="fr-select-group">
      <label class="fr-label" for="mode">Mode de mise à jour *</label>
      <select hx-get="{{ url_for('migrate_update_mode') }}"
              hx-target="#migrate-form-group-field"
              hx-trigger="change"
              required class="fr-select" id="mode" name="mode">
        <option value="" selected disabled hidden>Sélectionner un mode</option>
        <option value="{{ MigrateMode.CREATE.value }}">Création de nouvelles fiches (GENERATEUUID)</option>
        <option value="{{ MigrateMode.OVERWRITE.value }}">Mise à jour des fiches existantes (OVERWRITE)</option>
      </select>
    </div>
    <div id="migrate-form-group-field"></div>

    <button type="submit" class="fr-btn">Suivant</button>

    <div id="transform-results" class="fr-mt-4w">
      {# FIXME: keep? Precision isn't that important and makes UI more crowded
      <p>
        Les enregistrements ci-dessous sont listés dans l'ordre de traitement, du plus ancien au plus récent.
      </p>
      #}
      <fieldset class="fr-fieldset" id="status-filter-set"
                aria-labelledby="status-filter-legend status-filter-messages"
                hx-get="{{ url_for("transform_results_preview", job_id=job.id) }}"
                hx-target="#transform-results-preview"
                hx-trigger="load, change"
                hx-include="#main-form"
                hx-swap="innerHTML">
        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="status-filter-legend">
          Sélectionner :
        </legend>
        {% for status, items in results | groupby("status") | sort %}
          <div class="fr-fieldset__element fr-fieldset__element--inline fr-mr-2w">
            <div class="fr-checkbox-group">
              <input type="checkbox" name="status" id="status-filter-{{ loop.index }}"
                     value="{{ status }}" checked
                     aria-describedby="status-filter-messages-{{ loop.index }}">
              <label class="fr-label" for="status-filter-{{ loop.index }}">
                {{ status | status_legend }} <p class="fr-tag fr-tag--sm fr-ml-1w">{{ items | length }}</p>
              </label>
              <div class="fr-messages-group" id="status-filter-messages-{{ loop.index }}" aria-live="assertive">
              </div>
            </div>
          </div>
        {% endfor %}
        <div class="fr-messages-group" id="status-filter-messages" aria-live="assertive"></div>
      </fieldset>
    </div>
  </form>

  <div id="transform-results-preview" class="fr-mt-4w">
    {% include "fragments/transform_results_preview.html.j2" %}
  </div>
{% elif job_status == "failed" %}
  Le job est en erreur :-/
  <pre>{{ job.exc_info }}</pre>
{% else %}
  Statut inconnu : {{ job_status }}
{% endif %}
